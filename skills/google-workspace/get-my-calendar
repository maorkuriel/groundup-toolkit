#!/usr/bin/env python3
import os, sys, subprocess
from datetime import datetime, timedelta

# Load config from toolkit
sys.path.insert(0, os.path.join(os.path.dirname(__file__), '..', '..'))
from lib.config import config

os.environ["GOG_ACCOUNT"] = config.assistant_email
if "GOG_KEYRING_PASSWORD" not in os.environ:
    print("Warning: GOG_KEYRING_PASSWORD not set in environment", file=sys.stderr)

# Build lookup dicts from config
PHONE_TO_EMAIL = config.team_phones  # {phone: email}
NAME_MAP = {m['email']: m['name'].split()[0] for m in config.team_members}

def detect_phone():
    if len(sys.argv) > 1:
        return sys.argv[1]
    for var in ["OPENCLAW_TO", "OPENCLAW_FROM"]:
        phone = os.environ.get(var)
        if phone and "+" in phone:
            return phone
    return None

phone = detect_phone()
if not phone or phone not in PHONE_TO_EMAIL:
    known = ', '.join(PHONE_TO_EMAIL.keys())
    print(f"Phone {phone} not recognized. Known numbers: {known}")
    sys.exit(1)

email = PHONE_TO_EMAIL[phone]
name = NAME_MAP.get(email, email)

now = datetime.utcnow()
start = now.strftime("%Y-%m-%dT%H:%M:%SZ")
end = (now + timedelta(days=14)).strftime("%Y-%m-%dT%H:%M:%SZ")
max_events = sys.argv[2] if len(sys.argv) > 2 else "10"

print(f"{name}'s Calendar ({email})")
print("=" * 60)

cmd = ["gog", "calendar", "events", email, "--from", start, "--to", end, "--max", max_events]
result = subprocess.run(cmd, env=os.environ)
sys.exit(result.returncode)

# Note: This script is READ-ONLY
# For creating events, use: gog calendar create primary --attendees <user>
